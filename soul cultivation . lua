-- Soul Farm SUPER CHAIN v13 – ANTI-KICK SUPER + MOB SWITCH SUPER CEPAT & STABIL (NO CRASH)
-- Anti-Kick: gerak + lompat + mouse move + key spam setiap 2-3 menit random saat farm ON
-- Mob switch cepat: scan 0.5 detik, tween 400, direct CFrame fallback, threshold 6 studs
-- Stabil: full pcall, no heavy loops, optimized scan & tween

local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local VirtualUser = game:GetService("VirtualUser")
local VirtualInputManager = game:GetService("VirtualInputManager")

local player = Players.LocalPlayer
local farmToggleKey = Enum.KeyCode.F
local noclipToggleKey = Enum.KeyCode.N

local tweenSpeed = 200               -- Cepat untuk switch mob
local aboveDistance = 4              -- 4 studs di atas NPC
local verticalOffset = Vector3.new(0, aboveDistance, 0)
local attackRange = 15               -- Cocok untuk posisi atas dekat
local attackDelay = 0.05             -- 20 attack/detik
local refreshInterval = 0.5          -- Scan super cepat

local farming = false
local noclipEnabled = false
local originalY = nil
local attackCount = 0
local lastAfkAction = tick()

-- Fungsi mencari folder musuh
local function findEnemyFolder()
    return workspace:FindFirstChild("Enemies") 
        or workspace:FindFirstChild("Mobs") 
        or workspace:FindFirstChild("Enemy") 
        or workspace:FindFirstChild("NPC")
        or workspace:FindFirstChild("Monsters")
        or workspace:FindFirstChild("Bosses")
        or workspace:FindFirstChild("EnemyFolder")
end

local enemyFolder = findEnemyFolder()
local validEnemies = {}
local selectedTargets = {}

-- Remote Attack
local RemoteAttack = ReplicatedStorage:WaitForChild("RemoteEvents"):WaitForChild("Attack")

-- CORE FUNCTIONS
local function scanEnemies()
    validEnemies = {}
    if not enemyFolder or not enemyFolder.Parent then
        enemyFolder = findEnemyFolder()
        if not enemyFolder then
            warn("Folder musuh tidak ditemukan!")
            return false
        end
    end
    for _, v in pairs(enemyFolder:GetChildren()) do
        if v:IsA("Model") 
            and v:FindFirstChildWhichIsA("Humanoid") 
            and v.Humanoid.Health > 0 
            and v:FindFirstChild("HumanoidRootPart") then
            table.insert(validEnemies, v)
        end
    end
    return true
end

local function getHRP()
    local char = player.Character
    if char then
        return char:FindFirstChild("HumanoidRootPart")
    end
    return nil
end

local function tweenToPosition(targetPos)
    local hrp = getHRP()
    if not hrp then return false end
    
    local distance = (hrp.Position - targetPos).Magnitude
    if distance < 6 then return true end  -- Threshold kecil untuk switch cepat
    
    local time = distance / tweenSpeed
    local tweenInfo = TweenInfo.new(math.max(time, 0.05), Enum.EasingStyle.Linear)
    
    local success = pcall(function()
        local tween = TweenService:Create(hrp, tweenInfo, {CFrame = CFrame.new(targetPos)})
        tween:Play()
        tween.Completed:Wait()
    end)
    
    -- Fallback langsung kalau tween gagal (super stabil)
    if not success then
        pcall(function()
            hrp.CFrame = CFrame.new(targetPos)
        end)
    end
    
    return success
end

local function setNoclip(state)
    local char = player.Character
    if char then
        for _, part in pairs(char:GetDescendants()) do
            if part:IsA("BasePart") then
                part.CanCollide = not state
            end
        end
    end
end

local function toggleNoclip()
    noclipEnabled = not noclipEnabled
    setNoclip(noclipEnabled)
    print("Noclip: " .. (noclipEnabled and "ON" or "OFF"))
end

-- Anti jatuh lebih kuat
spawn(function()
    while true do
        RunService.Heartbeat:Wait()
        if farming or noclipEnabled then
            local hrp = getHRP()
            if hrp then
                if not originalY then originalY = hrp.Position.Y end
                if hrp.Position.Y < originalY - 50 then
                    hrp.CFrame = CFrame.new(hrp.Position.X, originalY + 10, hrp.Position.Z)
                    hrp.AssemblyLinearVelocity = Vector3.new()
                    hrp.AssemblyAngularVelocity = Vector3.new()
                end
            end
        else
            originalY = nil
        end
    end
end)

local function getNearestFromSelected()
    local hrp = getHRP()
    if not hrp then return nil end
    
    local nearest, minDist = nil, math.huge
    for _, enemy in ipairs(validEnemies) do
        if selectedTargets[enemy.Name] then
            local ehrp = enemy:FindFirstChild("HumanoidRootPart")
            local hum = enemy:FindFirstChildWhichIsA("Humanoid")
            if ehrp and hum and hum.Health > 0 and enemy.Parent then
                local dist = (hrp.Position - ehrp.Position).Magnitude
                if dist < minDist then
                    minDist = dist
                    nearest = enemy
                end
            end
        end
    end
    return nearest
end

local function countSelected()
    local count = 0
    for _ in pairs(selectedTargets) do count = count + 1 end
    return count
end

-- ANTI-KICK SUPER (lebih agresif, hampir pasti anti-kick di semua game)
local function doAntiKickAction()
    if not farming then return end
    local hrp = getHRP()
    if not hrp then return end
    
    -- Gerak kecil random lebih besar
    local randomDir = Vector3.new(math.random(-1,1)*10, 0, math.random(-1,1)*10)
    hrp.AssemblyLinearVelocity = randomDir
    
    -- Lompat + mouse simulation
    pcall(function()
        VirtualUser:Button2Down(Vector2.new(0,0), workspace.CurrentCamera.CFrame)
        wait(0.05)
        VirtualUser:Button2Up(Vector2.new(0,0), workspace.CurrentCamera.CFrame)
    end)
    
    -- Mouse move random untuk bypass idle detection
    pcall(function()
        VirtualUser:MoveMouseTo(Vector2.new(math.random(200, 1000), math.random(200, 800)))
        wait(0.1)
        VirtualUser:MoveMouseTo(Vector2.new(math.random(200, 1000), math.random(200, 800)))
    end)
    
    -- Tekan tombol random lebih banyak variasi
    local keys = {Enum.KeyCode.W, Enum.KeyCode.A, Enum.KeyCode.S, Enum.KeyCode.D, Enum.KeyCode.Space, Enum.KeyCode.LeftShift, Enum.KeyCode.LeftControl}
    local randomKey = keys[math.random(1, #keys)]
    pcall(function()
        VirtualInputManager:SendKeyEvent(true, randomKey, false, game)
        wait(0.05)
        VirtualInputManager:SendKeyEvent(false, randomKey, false, game)
    end)
    
    -- Tambah lompat manual
    pcall(function()
        game:GetService("VirtualInputManager"):SendKeyEvent(true, Enum.KeyCode.Space, false, game)
        wait(0.05)
        game:GetService("VirtualInputManager"):SendKeyEvent(false, Enum.KeyCode.Space, false, game)
    end)
    
    print("Anti-Kick: Action super dilakukan")
end

-- Fungsi farm utama
local function startFarm()
    if countSelected() == 0 then
        print("Pilih musuh dulu!")
        farming = false
        return
    end
    if not RemoteAttack then
        print("Remote Attack ga ketemu!")
        farming = false
        return
    end
    
    farming = true
    print("FARM ON v13 – Anti-Kick Super | Switch Cepat | Stabil No Crash")
    attackCount = 0
    
    spawn(function()
        local lastScan = tick()
        while farming do
            -- Scan super cepat
            if tick() - lastScan > 0.5 then
                scanEnemies()
                lastScan = tick()
            end
            
            -- Anti-kick agresif setiap 2-3 menit
            if tick() - lastAfkAction > math.random(120, 180) then
                doAntiKickAction()
                lastAfkAction = tick()
            end
            
            local target = getNearestFromSelected()
            
            if not target or not target.Parent or not target:FindFirstChildWhichIsA("Humanoid") or target.Humanoid.Health <= 0 then
                RunService.Heartbeat:Wait()
                continue
            end
            
            local ehrp = target:FindFirstChild("HumanoidRootPart")
            if not ehrp then continue end
            
            local hrp = getHRP()
            if not hrp then continue end
            
            local basePos = ehrp.Position + verticalOffset
            local sideOffset = Vector3.new(math.random(-2,2)*1.5, 0, math.random(-2,2)*1.5)
            local safePos = basePos + sideOffset
            
            if (hrp.Position - safePos).Magnitude > 6 then
                tweenToPosition(safePos)
            end
            
            local lastAttack = 0
            while farming and target.Parent and target:FindFirstChildWhichIsA("Humanoid") and target.Humanoid.Health > 0 do
                hrp = getHRP()
                ehrp = target:FindFirstChild("HumanoidRootPart")
                if not hrp or not ehrp then break end
                
                local currentSafePos = ehrp.Position + verticalOffset + sideOffset
                hrp.CFrame = CFrame.lookAt(currentSafePos, ehrp.Position)
                
                local dist = (hrp.Position - ehrp.Position).Magnitude
                if dist <= attackRange then
                    local now = tick()
                    if now - lastAttack >= attackDelay then
                        pcall(function()
                            local args = {
                                [1] = "Light",
                                [2] = {
                                    RootPart = ehrp
                                },
                            }
                            RemoteAttack:FireServer(unpack(args))
                        end)
                        attackCount = attackCount + 1
                        lastAttack = now
                    end
                end
                
                RunService.Heartbeat:Wait()
            end
        end
        
        print("FARM OFF | Total serangan: " .. attackCount)
        farming = false
    end)
end

-- GUI Lengkap
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "SoulFarmChainV13"
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = game:GetService("CoreGui")

local Frame = Instance.new("Frame")
Frame.Size = UDim2.new(0, 340, 0, 560)
Frame.Position = UDim2.new(0.5, -170, 0.5, -280)
Frame.BackgroundColor3 = Color3.fromRGB(25, 25, 32)
Frame.BorderSizePixel = 0
Frame.Active = true
Frame.Draggable = true
Frame.Parent = ScreenGui

local Title = Instance.new("TextLabel")
Title.Size = UDim2.new(1, 0, 0, 45)
Title.BackgroundColor3 = Color3.fromRGB(40, 40, 60)
Title.Text = "Soul Farm v13 – Anti-Kick Super | Switch Cepat"
Title.TextColor3 = Color3.fromRGB(255, 220, 100)
Title.Font = Enum.Font.SourceSansBold
Title.TextSize = 24
Title.Parent = Frame

local RefreshButton = Instance.new("TextButton")
RefreshButton.Size = UDim2.new(0.45, 0, 0, 40)
RefreshButton.Position = UDim2.new(0.05, 0, 0.09, 0)
RefreshButton.BackgroundColor3 = Color3.fromRGB(50, 140, 60)
RefreshButton.Text = "Refresh"
RefreshButton.TextColor3 = Color3.new(1, 1, 1)
RefreshButton.Font = Enum.Font.SourceSansBold
RefreshButton.TextSize = 16
RefreshButton.Parent = Frame

local CountLabel = Instance.new("TextLabel")
CountLabel.Size = UDim2.new(0.45, 0, 0, 40)
CountLabel.Position = UDim2.new(0.5, 0, 0.09, 0)
CountLabel.BackgroundTransparency = 1
CountLabel.Text = "Total: 0"
CountLabel.TextColor3 = Color3.fromRGB(180, 255, 180)
CountLabel.Font = Enum.Font.SourceSansBold
CountLabel.TextSize = 16
CountLabel.Parent = Frame

local SearchBox = Instance.new("TextBox")
SearchBox.Size = UDim2.new(0.9, 0, 0, 40)
SearchBox.Position = UDim2.new(0.05, 0, 0.17, 0)
SearchBox.BackgroundColor3 = Color3.fromRGB(45, 45, 55)
SearchBox.PlaceholderText = "Cari nama musuh..."
SearchBox.TextColor3 = Color3.new(1, 1, 1)
SearchBox.Font = Enum.Font.SourceSans
SearchBox.TextSize = 16
SearchBox.Parent = Frame

local ScrollFrame = Instance.new("ScrollingFrame")
ScrollFrame.Size = UDim2.new(0.9, 0, 0, 240)
ScrollFrame.Position = UDim2.new(0.05, 0, 0.26, 0)
ScrollFrame.BackgroundColor3 = Color3.fromRGB(35, 35, 42)
ScrollFrame.BorderSizePixel = 0
ScrollFrame.ScrollBarThickness = 6
ScrollFrame.CanvasSize = UDim2.new(0, 0, 0, 0)
ScrollFrame.Parent = Frame

local ListLayout = Instance.new("UIListLayout")
ListLayout.SortOrder = Enum.SortOrder.LayoutOrder
ListLayout.Padding = UDim.new(0, 4)
ListLayout.Parent = ScrollFrame

local TargetLabel = Instance.new("TextLabel")
TargetLabel.Size = UDim2.new(0.58, 0, 0, 40)
TargetLabel.Position = UDim2.new(0.05, 0, 0.60, 0)
TargetLabel.BackgroundColor3 = Color3.fromRGB(50, 50, 65)
TargetLabel.Text = "Targets: 0"
TargetLabel.TextColor3 = Color3.new(1, 1, 1)
TargetLabel.Font = Enum.Font.SourceSansBold
TargetLabel.TextSize = 18
TargetLabel.Parent = Frame

local AttackLabel = Instance.new("TextLabel")
AttackLabel.Size = UDim2.new(0.3, 0, 0, 40)
AttackLabel.Position = UDim2.new(0.64, 0, 0.60, 0)
AttackLabel.BackgroundColor3 = Color3.fromRGB(65, 50, 100)
AttackLabel.Text = "Attacks: 0"
AttackLabel.TextColor3 = Color3.fromRGB(255, 200, 255)
AttackLabel.Font = Enum.Font.SourceSansBold
AttackLabel.TextSize = 16
AttackLabel.Parent = Frame

local ToggleButton = Instance.new("TextButton")
ToggleButton.Size = UDim2.new(0.45, 0, 0, 55)
ToggleButton.Position = UDim2.new(0.05, 0, 0.71, 0)
ToggleButton.BackgroundColor3 = Color3.fromRGB(70, 150, 70)
ToggleButton.Text = "FARM OFF (F)"
ToggleButton.TextColor3 = Color3.new(1, 1, 1)
ToggleButton.Font = Enum.Font.SourceSansBold
ToggleButton.TextSize = 20
ToggleButton.Parent = Frame

local NoclipButton = Instance.new("TextButton")
NoclipButton.Size = UDim2.new(0.45, 0, 0, 55)
NoclipButton.Position = UDim2.new(0.5, 0, 0.71, 0)
NoclipButton.BackgroundColor3 = Color3.fromRGB(110, 110, 170)
NoclipButton.Text = "NOCLIP OFF (N)"
NoclipButton.TextColor3 = Color3.new(1, 1, 1)
NoclipButton.Font = Enum.Font.SourceSansBold
NoclipButton.TextSize = 20
NoclipButton.Parent = Frame

local Status = Instance.new("TextLabel")
Status.Size = UDim2.new(0.9, 0, 0, 40)
Status.Position = UDim2.new(0.05, 0, 0.85, 0)
Status.BackgroundTransparency = 1
Status.Text = "Status: Ready – Anti-Kick Super"
Status.TextColor3 = Color3.fromRGB(200, 255, 200)
Status.Font = Enum.Font.SourceSans
Status.TextSize = 18
Status.Parent = Frame

local TestButton = Instance.new("TextButton")
TestButton.Size = UDim2.new(0.9, 0, 0, 35)
TestButton.Position = UDim2.new(0.05, 0, 0.94, 0)
TestButton.BackgroundColor3 = Color3.fromRGB(150, 70, 70)
TestButton.Text = "Test Attack Nearest"
TestButton.TextColor3 = Color3.new(1, 1, 1)
TestButton.Font = Enum.Font.SourceSansBold
TestButton.TextSize = 16
TestButton.Parent = Frame

-- GUI Logic
local function matchesSearch(name)
    return SearchBox.Text == "" or string.find(string.lower(name), string.lower(SearchBox.Text), 1, true)
end

local function updateList()
    for _, child in pairs(ScrollFrame:GetChildren()) do
        if child:IsA("TextButton") then child:Destroy() end
    end
    
    local unique = {}
    for _, e in ipairs(validEnemies) do
        unique[e.Name] = (unique[e.Name] or 0) + 1
    end
    
    local order = 0
    for name, cnt in pairs(unique) do
        if matchesSearch(name) then
            order = order + 1
            local btn = Instance.new("TextButton")
            btn.Name = name
            btn.Size = UDim2.new(1, 0, 0, 40)
            local sel = selectedTargets[name] or false
            btn.BackgroundColor3 = sel and Color3.fromRGB(100, 160, 100) or Color3.fromRGB(55, 55, 65)
            btn.Text = (sel and "☑ " or "☐ ") .. name .. " (" .. cnt .. ")"
            btn.TextColor3 = Color3.new(1, 1, 1)
            btn.Font = Enum.Font.SourceSans
            btn.TextSize = 16
            btn.LayoutOrder = order
            btn.Parent = ScrollFrame
            
            btn.MouseButton1Click:Connect(function()
                selectedTargets[name] = not selectedTargets[name]
                TargetLabel.Text = "Targets: " .. countSelected()
                updateList()
            end)
        end
    end
    
    ScrollFrame.CanvasSize = UDim2.new(0, 0, 0, ListLayout.AbsoluteContentSize.Y + 20)
    CountLabel.Text = "Total: " .. #validEnemies
end

RefreshButton.MouseButton1Click:Connect(function()
    scanEnemies()
    updateList()
end)

SearchBox:GetPropertyChangedSignal("Text"):Connect(updateList)

ToggleButton.MouseButton1Click:Connect(function()
    farming = not farming
    if farming then
        startFarm()
        ToggleButton.Text = "FARM ON (F)"
        ToggleButton.BackgroundColor3 = Color3.fromRGB(170, 70, 70)
        Status.Text = "Farming aktif + Anti-Kick Super"
    else
        ToggleButton.Text = "FARM OFF (F)"
        ToggleButton.BackgroundColor3 = Color3.fromRGB(70, 150, 70)
        Status.Text = "Idle"
    end
end)

NoclipButton.MouseButton1Click:Connect(function()
    toggleNoclip()
    NoclipButton.Text = "NOCLIP " .. (noclipEnabled and "ON" or "OFF") .. " (N)"
    NoclipButton.BackgroundColor3 = noclipEnabled and Color3.fromRGB(170, 100, 170) or Color3.fromRGB(110, 110, 170)
end)

TestButton.MouseButton1Click:Connect(function()
    local target = getNearestFromSelected()
    if not target then 
        print("Tidak ada target!")
        return 
    end
    local ehrp = target:FindFirstChild("HumanoidRootPart")
    if ehrp then
        pcall(function()
            local args = {
                [1] = "Light",
                [2] = {
                    RootPart = ehrp
                },
            }
            RemoteAttack:FireServer(unpack(args))
        end)
        print("Test attack ke: " .. target.Name)
    end
end)

UserInputService.InputBegan:Connect(function(input, gpe)
    if gpe then return end
    if input.KeyCode == farmToggleKey then
        ToggleButton.MouseButton1Click:Fire()
    elseif input.KeyCode == noclipToggleKey then
        NoclipButton.MouseButton1Click:Fire()
    end
end)

spawn(function()
    while true do
        wait(refreshInterval)
        scanEnemies()
        if not farming then
            updateList()
        end
        AttackLabel.Text = "Attacks: " .. attackCount
    end
end)

updateList()
print("Soul Farm v13 LOADED – Anti-Kick Super | Switch Cepat | Stabil No Crash")
print("1. Noclip ON (N) – WAJIB")
print("2. Refresh list")
print("3. Centang musuh")
print("4. Tekan F untuk mulai farm")
print("Anti-kick sekarang super agresif, kamu hampir pasti tidak akan ke-kick walau AFK lama")
